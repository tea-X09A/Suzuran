# 包括的リファクタリングスラッシュコマンド

コードベース全体または指定された範囲の包括的なリファクタリングを段階的に実行し、品質を保証しながら最適化を行います。

## 引数
- `$1`: リファクタリング対象の範囲やタスクの詳細説明

## 実行プロセス

### Phase 1: 現状分析（並行実行）
```
以下のサブエージェントを Task tool で並行実行：

1. directory-analyzer
   - プロジェクト構造を分析し、${1}のリファクタリング範囲を特定

2. config-file-investigator  
   - 現在の設定ファイルを調査し、リファクタリングに必要な設定変更を確認

3. dependency-analyzer
   - ${1}に関連するファイルの依存関係を分析し、影響範囲を特定

4. code-quality-analyzer
   - 技術的負債・アンチパターンの検出

5. code-duplication-detector
   - コード重複の発見と共通化候補の特定

6. performance-issue-detector
   - パフォーマンス問題の特定

7. typescript-type-coverage-analyzer
   - TypeScript型カバレッジ分析
```

### Phase 2: リファクタリング計画作成
TodoWrite tool でタスク管理しながら以下を計画：
- リファクタリング優先順位の決定
- 影響範囲の最小化戦略
- 段階的実行計画（依存関係順）
- 型安全性向上計画
- パフォーマンス最適化計画
- テスト戦略
- ロールバック計画

### Phase 3: 段階的リファクタリング実行
TodoWrite で進捗管理しながら、メインエージェントで以下を順次実行：

#### 3.1 構造リファクタリング
```
1. 複数ファイルにまたがる構造変更
   - コードアーキテクチャの再構築
   - 共通パターンの抽出
   - モジュール依存関係の再編成

2. 重複コードの共通化・抽出
   - 類似コードパターンの特定と統合
   - 再利用可能なコンポーネント・ユーティリティの作成
   - DRY原則に基づく最適化

3. 関数・メソッド抽出による責任分離
   - 大きな関数の分割
   - 単一責任原則の適用
   - 関心事の分離

4. 巨大コンポーネントの分割
   - 大きなReactコンポーネントの分解
   - より小さく管理しやすいコンポーネントへの分割
   - 単一責任原則の適用
```

#### 3.2 TypeScript強化
```
1. TypeScript型定義の強化
   - any型の置き換え
   - 適切な型注釈の追加
   - より厳格な型安全性の確保

2. 型の統合・整理
   - 重複する型定義のマージ
   - 型階層の整理
   - 再利用可能な型パターンの抽出

3. APIインターフェースの統一
   - 類似APIエンドポイントの統合
   - 一貫したレスポンス形式の確保
   - 統一されたエラーハンドリングパターン

4. Props型の最適化
   - React コンポーネントProps型の改善
   - 型安全性と再利用性の向上
   - 適切な型パターンの適用
```

#### 3.3 React最適化
```
1. React フックの最適化・統合
   - 重複するフックロジックの統合
   - useEffect依存関係の最適化
   - useCallback/useMemoによるパフォーマンス向上

2. 関連するhooksの統合
   - 類似した状態管理ロジックの統合
   - カスタムフックの作成と最適化
   - フックパターンの統一
```

#### 3.4 パフォーマンス最適化
```
1. パフォーマンス最適化
   - ボトルネックの特定と改善
   - 再レンダリングの最適化
   - ランタイム効率の向上

2. バンドルサイズ最適化
   - 大きな依存関係の特定
   - 動的インポートの最適化
   - コード分割戦略の実装
```

#### 3.5 スタイル・命名統一
```
1. 命名規則の統一
   - 変数・関数名の一貫性確保
   - より明確で説明的な名前への変更
   - プロジェクト命名規則の適用

2. CSS Modules の統合・整理
   - 重複するスタイルのマージ
   - 命名規則の統一
   - CSS構造の最適化
```

### Phase 4: 品質検証（順次実行）
```
以下のサブエージェントを Task tool で順次実行：

1. code-formatter-linter
   - リファクタリング後のコードフォーマットとlint実行

2. typescript-error-checker
   - TypeScript型エラー確認

3. build-success-verifier
   - ビルド成功確認

4. test-coverage-analyzer
   - 関連テストを実行し、カバレッジを分析

5. regression-test-runner
   - リファクタリング後の回帰テスト

6. api-compatibility-checker
   - APIインターフェース互換性確認

7. post-format-code-reviewer
   - 最終的な品質確認とCLAUDE.md準拠チェック
```

## 実行方法
```
/refactor [リファクタリング対象の説明]
```

## 使用例
```
/refactor src/components/common ディレクトリ全体のコンポーネントを最適化

/refactor ユーザー認証関連のコードを型安全性を向上させて整理

/refactor パフォーマンスボトルネックを解消し、レンダリング速度を向上

/refactor 重複するビジネスロジックを共通化してメンテナンス性を向上

/refactor Zustandストア全体を最新のベストプラクティスに準拠するよう更新
```

## リファクタリング原則
- **段階的実行**: 一度に大きな変更を行わず、小さな単位で確実に実行
- **後方互換性**: 既存のAPIインターフェースを可能な限り維持
- **型安全性**: TypeScript厳格型定義を最優先
- **テスト保持**: 既存のテストが通ることを各段階で確認
- **品質向上**: CLAUDE.mdの全原則を遵守し、既存より高い品質を目指す

## エラーハンドリング
- 各フェーズでエラーが発生した場合、該当フェーズで停止
- 問題の詳細と推奨される対処法を表示
- 必要に応じてロールバック手順を提示
- 複雑な依存関係が原因の場合は、dependency-analyzer での再分析を提案

## 注意事項
- リファクタリング前に必ずバックアップまたはgitコミットを確認
- 本番環境への影響を考慮し、テスト環境での検証を推奨
- 大規模な変更の場合は、段階的なデプロイメント戦略を検討